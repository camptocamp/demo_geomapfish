#!/bin/bash -eux

for lang in $(cd /tmp/config/geoportal/geomapfish_geoportal/locale/; ls -d */ | sed "s#/##")
do
    msgfmt -o /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-client.mo \
        /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-client.po
    msgfmt -o /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-server.mo \
        /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-server.po
    node /usr/bin/compile-catalog \
        /opt/c2cgeoportal/geoportal/c2cgeoportal_geoportal/locale/${lang}/LC_MESSAGES/ngeo.po \
        /opt/c2cgeoportal/geoportal/c2cgeoportal_geoportal/locale/${lang}/LC_MESSAGES/gmf.po \
        /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-client.po \
        > /tmp/config/geoportal/geomapfish_geoportal/static/${lang}.json
    if [ "${SIMPLE}" == TRUE ]
    then \
        mv /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-client.mo \
            /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfishapp_geoportal-client.mo
        if [ -e /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-server.mo ]
        then
            mv /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfish_geoportal-server.mo \
                /tmp/config/geoportal/geomapfish_geoportal/locale/${lang}/LC_MESSAGES/geomapfishapp_geoportal-server.mo
        fi
    fi
done

rm -rf /tmp/config/geoportal/geomapfish_geoportal/locale/*/LC_MESSAGES/*.po
