---

name: Upgrade 2.5

on:
  repository_dispatch:
    types:
      - geomapfish_25_updated

jobs:
  upgrade:
    runs-on: ubuntu-18.04
    name: Upgrade 2.5
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v2
        with:
          ref: 'prod-2-5'

      - name: Update the demo
        run: scripts/upgrade ${{ github.event.client_payload.version }} "https://c2c-bot-gis-ci:${{ secrets.GITHUB_GOPASS_CI_TOKEN }}@github.com/camptocamp/demo_geomapfish.git"
      - name: Push interrupted Upgrade
        run: |
          git add --all || true
          git add --force .UPGRADE_INSTRUCTIONS || true
          git status
          git commit -m "Interrupted upgrade to ${MAJOR_VERSION}"
          remote_repo="https://c2c-bot-gis-ci:${{ secrets.GITHUB_GOPASS_CI_TOKEN }}@github.com/camptocamp/demo_geomapfish.git"
          git push "remote_repo=${remote_repo}" --force origin HEAD:interrupted-upgrade-${MAJOR_VERSION}
        if: failure()
