---

name: Upgrade 2.5

on:
  repository_dispatch:
    types:
      - geomapfish_25_updated

jobs:
  upgrade:
    runs-on: ubuntu-18.04
    name: Upgrade 2.5
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v2
        with:
          ref: 'prod-2-5'
          token: ${{ secrets.GITHUB_GOPASS_CI_TOKEN }}

      - name: Update the demo
        run: scripts/upgrade ${{ github.event.client_payload.version }} origin
      - name: Push interrupted Upgrade
        run: |
          git add --all || true
          git add --force .UPGRADE_INSTRUCTIONS || true
          git status
          git commit -m "Interrupted upgrade to ${MAJOR_VERSION}"
          git push --force origin HEAD:interrupted-upgrade-25
          curl -X POST --data '{
                "title": "Upgrade failed",
                "body": "See https://github.com/camptocamp/demo_geomapfish/actions?query=workflow%3A%22Upgrade+2.6%22",
                "head": "interrupted-upgrade-25",
                "base": "prod-2-5",
                "maintainer_can_modify": True,
            }' \
            --header Accept=application/vnd.github.v3+json \
            --header Authorization="Bearer ${{ secrets.GITHUB_GOPASS_CI_TOKEN }}" \
            --header Content-Type=application/json \
            https://github.com/camptocamp/demo_geomapfish/pulls
        if: failure()
